---
title: "Journal Club FAO Scatterplot"
author: "Ben"
date: "1/28/2021"
output: html_document
---
## Objective
- Import and clean FAO data on yield, cropland area, and population
- Replicate/modernize Ewers (2009) scatterplot using data from 1999-20182

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include = F}
library(tidyverse)
```

#### Read in Data

 23 "Staple Crops" were selected according to Ewers 2009, with yield, acreage, and population data imported for 1999-2018. 
 
 Below analyses are currently for 1999-2018

```{r Initial Data read-in}

staple_data <- read.csv("../data/fao_staples.csv", sep = ",", header = T) %>% 
  filter(Year == 1999 | Year == 2018)
pop_data <- read.csv("../data/fao_pop.csv", sep = ",", header = T) %>%
  filter(Year == 1999 | Year == 2018) %>% 
  dplyr::mutate(Population = Value*1000) %>% 
  dplyr::select(Area,Population,Year)

# Joining Area with population, calculating crop hectares per capita
pc.area <- left_join(staple_data %>% filter(Element == "Area harvested"),pop_data) %>% 
  dplyr::mutate(ha_percap = Value/Population)%>% 
  dplyr::select(Area,Item,Year,ha_percap)

# Separating out values by year for comparison
pc.area.tall <- pivot_wider(pc.area, names_from = Year, values_from = ha_percap, names_prefix = "x") %>% 
  dplyr::filter(!is.na(x2018) & !is.na(x1999) & x2018 != 0 & x1999 !=0) 

# Calculation on log(percap cropland ratio 2018: 1999) according to Ewers 2009
pc.area.dif <- pc.area.tall %>% 
  group_by(Area) %>% 
  dplyr::summarise(total.1999 = sum(x1999), total.2018 = sum(x2018)) %>% 
  dplyr::mutate(log.delta.area = log(total.2018 / total.1999)) %>% 
  dplyr::mutate(dir = if_else(log.delta.area >= 0, "+", "-")) %>% 
  dplyr::select(-total.1999,-total.2018)

pc.area.dif
```
This shows the values and directionality for the change in cropland area for the same 23 staple crops analyzed in Ewers 2009.  In this case, these values represent the Y-axis of Fig. 2 from that paper. Notably, some of the values are quite extreme comparatively, with nearly twice as much cropland area per capita lost as compare to the 1979-1999 period. This is in line with overall cropland area estimates though.

```{r yield ratio calculation}
yield <- staple_data %>% filter(Element == "Yield") %>% 
  dplyr::select(Area,Item,Year,Unit,Value) 

yield.tall <- pivot_wider(yield, names_from = Year, values_from = Value, names_prefix = "x") %>% 
  dplyr::filter(!is.na(x2018) & !is.na(x1999) & x2018 != 0 & x1999 !=0) 

# Manually creating calorie list because no tables exist :(
# Stolen from https://iopscience.iop.org/1748-9326/8/3/034015/media/erl472821suppdata.pdf 

kcal = data.frame(c("Apples","Barley", "Bananas","Cassava","Coconuts", "Cottonseed", "Grapes", "Maize", "Millet",
                    "Oats", "Onions, dry", "Oil palm fruit", "Plantains", "Potatoes", "Rice, paddy", "Sorghum",
                    "Soybeans", "Sugar beet", "Sugar cane", "Sunflower seed", "Sweet potatoes", "Vegetables, fresh nes",
                    "Wheat", "Yams"),  
                  c(479479.33, 3360215.93,614244.63,1058035.85,1430000.04, 4100000.00, 591589.58, 3580802.60, 3463917.52,
                    3850000.19, 394971.60, 5400000.00, 846666.67, 702122.60, 2800000.00, 3430000.40,
                    3596499.11, 700000.00, 291428.56, 2982902.68, 939797.99, 220000.00,
                    3284000.00,1090000.00))
colnames(kcal) = c("Item", "kcal.tonne")
kcal <- kcal %>% 
  dplyr::mutate(kcal.hg = kcal.tonne/10000)
# write.csv(kcal, "../data/kcal_staple.csv") # NEVER AGAIN

# Conversion
kcal.ha <- left_join(yield.tall,kcal %>% dplyr::select(Item,kcal.hg)) %>% 
  dplyr::mutate(kcal.ha.1999 = x1999*kcal.hg, kcal.ha.2018 = x2018*kcal.hg) %>% 
  dplyr::select(Area, Item, kcal.ha.1999, kcal.ha.2018) %>% 
  dplyr::filter(!is.na(kcal.ha.1999) & !is.na(kcal.ha.2018))

kcal.yield.dif <- kcal.ha %>% 
  group_by(Area) %>% 
  dplyr::summarise(total.1999 = sum(kcal.ha.1999), total.2018 = sum(kcal.ha.2018)) %>% 
  dplyr::mutate(log.delta.yield = log(total.2018 / total.1999)) %>% 
  dplyr::mutate(dir.1 = if_else(log.delta.yield >= 0, "+", "-")) %>% 
  dplyr::select(Area,log.delta.yield,dir.1)
kcal.yield.dif
```
In this case, the yield values are quite similar to those from Ewers.  It's possible that kcal yield per hectare for these staples hasn't changed much since 1999, but let's visualize these together in a format similar to Ewers Figure 2.

```{r}
combined_data <- left_join(pc.area.dif,kcal.yield.dif) 
head(combined_data)

ggplot(data = combined_data, mapping = aes(x = log.delta.yield, y = log.delta.area)) + theme_classic() +
         geom_point() + geom_hline(yintercept = 0) + geom_vline(xintercept = 0) + geom_smooth(method = "lm") + xlim(-.6,1.5)+
  ylim(-3.5,1.5) + labs(x = "log(yield ratio 1999:2018)", y = "log(per capita cropland ratio 1999:2018)")

```

